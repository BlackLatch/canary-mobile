# Relay Mobile Integration

This document describes the integration of the Relay Go backend into the Canary React Native mobile app.

## Overview

The Relay mobile_standalone code has been successfully embedded into this React Native app, allowing direct calls from JavaScript/TypeScript to Go code through a Kotlin bridge.

## Architecture

```
React Native (TypeScript/JavaScript)
    ↓
Native Module (Kotlin - RelayModule.kt)
    ↓
Java Bindings (Auto-generated by gomobile)
    ↓
Go Code (mobile_standalone/relay.go)
```

## Files Added/Modified

### Android Native Code
- `android/app/libs/mobile.aar` - Go mobile bindings compiled as Android Archive
- `android/app/src/main/java/go/*` - Go sequence support classes
- `android/app/src/main/java/mobile/*` - Java bindings for Go mobile API
- `android/app/src/main/java/com/canarymobile/RelayModule.kt` - React Native bridge module
- `android/app/src/main/java/com/canarymobile/RelayPackage.kt` - React Native package registration
- `android/app/src/main/java/com/canarymobile/MainApplication.kt` - Updated to register RelayPackage
- `android/app/build.gradle` - Updated to include mobile.aar and NDK configuration

### React Native/TypeScript Code
- `src/native/RelayModule.ts` - TypeScript wrapper with type definitions
- `src/native/RelayModuleExample.tsx` - Example component showing usage

## Available Methods

The following methods are exposed from Go to React Native:

### Initialization
- `initialize(dataDir: string)` - Initialize Relay with data directory
- `isInitialized()` - Check if initialized
- `getDataDirectory()` - Get current data directory

### Account Management
- `createAccount(nickname, torOnly, servers, passphrase)` - Create new account
- `listAccounts()` - Get all accounts as JSON
- `getAccountInfo(accountID)` - Get account details
- `getAccountByNickname(nickname)` - Find account by nickname
- `editAccount(accountID, newNickname)` - Update account nickname
- `deleteAccount(accountID)` - Delete an account

### Contact Management
- `getContacts()` - Get all contacts as JSON
- `createContact(accountID, nickname, servers)` - Add new contact
- `createContactFromAccountString(accountString)` - Add contact from string format
- `editContact(accountID, newNickname)` - Update contact nickname
- `deleteContact(accountID)` - Remove a contact

### Messaging
- `sendTextMessage(fromAccountID, toAccountID, message)` - Send text
- `sendFile(fromAccountID, toAccountID, filePaths)` - Send file(s)
- `startConnectLoop(accountNicknames)` - Start listening for messages

### State Management
- `getInitialState()` - Get all state (accounts, settings, etc.)

## Usage Example

```typescript
import RelayModule from './native/RelayModule';

// Initialize
await RelayModule.initialize('');

// Create an account
const accountId = await RelayModule.createAccount(
  'MyNickname',
  false, // torOnly
  [], // servers (empty = use defaults)
  '' // passphrase
);

// List accounts
const accounts = await RelayModule.listAccounts();
console.log('Accounts:', accounts);

// Send a message
await RelayModule.sendTextMessage(
  fromAccountId,
  toAccountId,
  'Hello from React Native!'
);

// Listen for messages
RelayModule.addMessageListener((messageJSON) => {
  const message = JSON.parse(messageJSON);
  console.log('Received:', message);
});

await RelayModule.startConnectLoop(['MyNickname']);
```

## Building the Project

### Prerequisites
- Go 1.21+
- gomobile installed: `go install golang.org/x/mobile/cmd/gomobile@latest`
- Android SDK and NDK configured

### Regenerating Go Bindings

If you make changes to the Go code in `/home/user/django_projects/relay/mobile_standalone/relay.go`, you'll need to regenerate the AAR:

```bash
cd /home/user/django_projects/relay/mobile_standalone
gomobile bind -target=android -androidapi=21

# Copy to React Native project
cp mobile.aar /path/to/canary-mobile/android/app/libs/
```

### Building the React Native App

```bash
# Install dependencies
npm install

# Run on Android
npm run android
```

## Testing

A test component is available at `src/native/RelayModuleExample.tsx` that demonstrates:
- Initialization
- Account creation
- Message sending
- Event listening

To use it, import and render it in your app:

```typescript
import RelayExample from './native/RelayModuleExample';

// In your component
<RelayExample />
```

## Event Listeners

The module emits events that you can listen to:

```typescript
// Listen for incoming messages
const messageListener = RelayModule.addMessageListener((messageJSON) => {
  const message = JSON.parse(messageJSON);
  // Handle message
});

// Listen for errors
const errorListener = RelayModule.addErrorListener((error) => {
  console.error('Relay error:', error.error);
});

// Clean up when done
messageListener.remove();
errorListener.remove();
```

## Message Format

Messages received from the Go backend are JSON strings with this structure:

```json
{
  "Type": "text",
  "From": "sender_account_id",
  "To": "recipient_account_id",
  "Text": "message content",
  "Files": ["file1.txt", "file2.jpg"]
}
```

## Data Storage

By default, Relay stores data in the app's internal storage at:
```
/data/data/com.blacklatch.canary/files/relay/
```

This includes:
- `relay.db` - SQLite database with accounts and messages
- `Downloads/` - Received files

## Troubleshooting

### Build Errors

If you get errors about missing native methods:
1. Make sure `mobile.aar` is in `android/app/libs/`
2. Clean and rebuild: `cd android && ./gradlew clean && cd ..`
3. Reinstall the app

### Runtime Errors

If you get "Relay API not initialized":
1. Call `RelayModule.initialize('')` before any other methods
2. Check that initialization succeeded without throwing

### Message Loop Not Working

If `startConnectLoop` doesn't receive messages:
1. Make sure accounts exist and are properly configured
2. Check that server URLs are accessible
3. Look for errors in `adb logcat`

## Architecture Notes

### Why Kotlin Instead of Direct Java?

Kotlin provides better null safety and more concise syntax for React Native modules, making the code more maintainable.

### Why Not Use TurboModules?

TurboModules would provide better type safety and performance, but require more complex setup. The current bridge approach is simpler and works well for this use case.

### Thread Safety

The `startConnectLoop` method runs in a background thread and emits events back to the JavaScript thread. This is handled automatically by React Native's event system.

## Reference Implementation

This integration is based on the pattern used in `/home/user/django_projects/relay/gui/RelayMobile`, which is a Kotlin Multiplatform Compose app that also uses gomobile bindings.

## Next Steps

Potential improvements:
1. Add TurboModule support for better performance
2. Implement iOS bindings (requires gomobile bind for iOS)
3. Add more detailed error handling and logging
4. Implement progress callbacks for file transfers
5. Add unit tests for the native module
